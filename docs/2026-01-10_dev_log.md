# 2026-01-10 Development Summary

## Tab 切换动画修复 (Animation Fix)
*   **Goal**: 修复 Dashboard 中 "All Tasks" 与 "All Notes" 切换时的异常动画效果。
*   **Problem Analysis**:
    *   切换 tab 时出现内容"向上弹"的视觉问题。
    *   **根本原因**: 使用 `AnimatePresence` 条件渲染时，切换会触发组件的卸载/挂载，导致内部子组件（`TodoItem`、`NotesView` 卡片）的入场动画 `initial={{ opacity: 0, y: 12 }}` 被重新触发。
    *   每个子元素从 `y: 12` 动画到 `y: 0`，整体产生"向上弹"效果。
    *   此外，之前尝试在动画中切换 `position: absolute/relative`，但 CSS `position` 属性不支持平滑过渡，会导致布局瞬间跳变。
*   **Solution**:
    *   移除 `AnimatePresence` 的条件渲染逻辑。
    *   改用**双视图常驻挂载** + CSS 控制显隐的方案：
        *   活跃视图: `opacity-100`（正常显示）
        *   非活跃视图: `opacity-0 absolute inset-0 pointer-events-none`（透明、脱离文档流、不可点击）
    *   使用 `transition-opacity duration-150` 实现平滑淡入淡出。
*   **Key Changes** (`Dashboard.tsx`):
    *   两个视图始终保持挂载状态，不会触发内部组件的入场动画。
    *   切换时只有纯粹的 opacity 过渡，无布局跳变。
*   **Outcome**: 切换动画流畅自然，无"向上弹"问题。

---

## 全屏编辑器优化 (Fullscreen Editor Enhancements)

### 1. 全屏居中与过渡动画
*   **Problem**: 全屏模式不居中，展开/收起缺乏过渡感。
*   **Solution** (`NoteEditor.tsx`):
    *   使用独立的 backdrop 和 content 层，分离动画效果
    *   Backdrop: 简单的 opacity 淡入淡出
    *   Content: Spring 动画，从 `y: '30%', scale: 0.9` 展开到 `y: 0, scale: 1`
    *   退出时: `y: '20%', scale: 0.95` 配合淡出
    *   Spring 参数: `stiffness: 350, damping: 30, mass: 0.8`
*   **Outcome**: 全屏展开有从下方弹出的过渡感，关闭时平滑收回。

### 2. 快捷键提示功能
*   **Goal**: 在全屏模式下显示键盘快捷键提示。
*   **Implementation** (`NoteEditor.tsx`):
    *   Header 中添加键盘图标按钮
    *   点击弹出毛玻璃风格 popover，显示所有可用快捷键
    *   快捷键分类：文本格式、段落、编辑
    *   支持点击外部关闭、ESC 键关闭
    *   Spring 动画弹出效果
*   **Shortcuts 列表**:
    | 分类 | 快捷键 | 功能 |
    |------|--------|------|
    | 文本格式 | `⌘B` | 粗体 |
    | 文本格式 | `⌘I` | 斜体 |
    | 文本格式 | `⌘U` | 下划线 |
    | 文本格式 | `⌘E` | 行内代码 |
    | 文本格式 | `⌘⇧X` | 删除线 |
    | 段落 | `⌘⌥1-6` | 标题级别 |
    | 段落 | `⌘⇧7` | 有序列表 |
    | 段落 | `⌘⇧8` | 无序列表 |
    | 段落 | `⌘⇧9` | 引用块 |
    | 段落 | `⌘⌥C` | 代码块 |
    | 编辑 | `⌘Z` | 撤销 |
    | 编辑 | `⌘⇧Z` | 重做 |
    | 编辑 | `⌘A` | 全选 |

### 3. 工具栏位置优化
*   **Problem**: 全屏模式工具栏在底部，不符合常规编辑器习惯。
*   **Solution** (`TiptapEditor.tsx`):
    *   新增 `toolbarPosition` 属性: `'top' | 'bottom'`
    *   普通模式: 工具栏在底部（默认）
    *   全屏模式: 工具栏在顶部 (`toolbarPosition="top"`)
*   **Key Changes**:
    *   提取 Toolbar 为变量，根据 `toolbarPosition` 条件渲染位置
    *   顶部工具栏使用 `border-b`，底部使用 `border-t pb-safe`

### 4. 内容居中显示
*   **Problem**: 全屏模式内容撑满整个宽度，阅读体验差。
*   **Solution** (`TiptapEditor.tsx`):
    *   新增 `centered` 属性: `boolean`
    *   `centered={true}`: 内容居中，限制最大宽度 (`max-w-3xl mx-auto`)
    *   `centered={false}`: 内容撑满宽度 (`max-w-none`)
*   **Note**: Source 模式保持左对齐全宽，更适合代码编辑。

### 5. 移动端工具栏滑动提示
*   **Problem**: 移动端工具栏按钮显示不全，用户不知道可以滑动。
*   **Solution** (`TiptapEditor.tsx`):
    *   右侧添加白色渐变遮罩提示（`w-8`）
    *   渐变: `linear-gradient(to left, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%)`
    *   末尾添加 `w-4` 空白，防止最后按钮被遮挡
    *   分隔线添加 `shrink-0` 防止收缩
*   **Outcome**: 用户看到右侧渐变即知可左滑查看更多按钮。

---

## 文件变更汇总

| 文件 | 变更内容 |
|------|----------|
| `NoteEditor.tsx` | 全屏动画、快捷键提示、调用 TiptapEditor 新属性 |
| `TiptapEditor.tsx` | `toolbarPosition`、`centered` 属性、滑动渐变提示 |

---

## Settings 功能实现 (Settings Feature)

### 1. 后端 API 新增
*   **密码修改 API** (`PUT /users/me/password`):
    *   接收 `current_password` 和 `new_password`
    *   验证当前密码后更新
*   **数据导出 API** (`GET /users/me/export`):
    *   导出用户信息和所有 todos
    *   返回 JSON 格式数据

### 2. 前端架构新增

#### ThemeContext (主题切换)
*   **文件**: `src/contexts/ThemeContext.tsx`
*   **功能**:
    *   支持 `light` / `dark` / `system` 三种模式
    *   `resolvedTheme` 返回实际应用的主题
    *   监听系统主题变化自动切换
    *   持久化到 localStorage
    *   应用 `dark` class 到 `document.documentElement`

#### LanguageContext (语言切换)
*   **文件**: `src/contexts/LanguageContext.tsx`
*   **功能**:
    *   支持 `zh` / `en` 双语
    *   `t(key)` 翻译函数，支持嵌套 key
    *   自动检测浏览器语言
    *   持久化到 localStorage

#### i18n 翻译文件
*   `src/i18n/zh.json` - 中文翻译
*   `src/i18n/en.json` - 英文翻译
*   涵盖: common、tabs、filter、settings、theme、language 等模块

### 3. 深色模式样式
*   **文件**: `src/index.css`
*   **变更**: 为所有 glass-* 组件添加 dark 变体
    | 组件 | 深色模式样式 |
    |------|-------------|
    | `.dark .glass-panel` | `bg-gray-800/70 border-gray-700/50` |
    | `.dark .glass-card` | `bg-gray-800/50 border-gray-700/40` |
    | `.dark .glass-nav` | `bg-gray-800/60 border-gray-700/50` |
    | `.dark .glass-modal` | `bg-gray-800/90 border-gray-700/60` |
    | `.dark .glass-input` | `bg-gray-700/40 border-gray-600/50` |
    | `.dark .glass-fab` | `bg-indigo-600/90 border-indigo-500/30` |
*   **背景渐变**: `linear-gradient(135deg, #0f0d1a ... #0f0d1a)`

### 4. Sidebar 内置 Settings (核心变更)
*   **设计决策**: Settings 不作为独立页面，而是集成在 Sidebar 内部
*   **交互流程**:
    1. 点击菜单按钮 → 打开 Sidebar（显示筛选菜单）
    2. 点击 Settings → 内容平滑切换到设置页面
    3. 点击返回箭头 → 返回菜单视图
    4. 关闭 Sidebar → 自动重置为菜单视图

*   **实现方式** (`Sidebar.tsx`):
    *   `view` 状态: `'menu' | 'settings'`
    *   两个 `motion.div` 做左右滑动动画切换
    *   Spring 动画: `stiffness: 300, damping: 30`

*   **Settings 功能列表**:
    | 分类 | 功能 | 说明 |
    |------|------|------|
    | 账户 | 头像修改 | Base64 上传 |
    | 账户 | 昵称修改 | 内联编辑 |
    | 账户 | 邮箱显示 | 只读 |
    | 账户 | 密码修改 | Modal 弹窗 |
    | 外观 | 主题切换 | 浅色/深色/跟随系统 |
    | 外观 | 语言切换 | 中文/English |
    | 数据 | 导出数据 | 下载 JSON 文件 |
    | 关于 | 版本信息 | v1.0.0 |

### 5. 其他组件适配
*   **BottomNav.tsx**: 添加深色模式样式
*   **Dashboard.tsx**:
    *   Header 添加深色模式样式
    *   i18n 支持 (`getFilterTitle` 使用翻译)
    *   传递 `onUserUpdate` 给 Sidebar
*   **App.tsx**: 包裹 `ThemeProvider` 和 `LanguageProvider`
*   **tailwind.config.js**: 启用 `darkMode: 'class'`

---

## 文件变更汇总 (Settings)

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `backend/app/schemas/user.py` | 新增 | ChangePasswordRequest schema |
| `backend/app/api/routes/users.py` | 修改 | 新增 2 个 API 端点 |
| `src/contexts/ThemeContext.tsx` | 新增 | 主题管理 |
| `src/contexts/LanguageContext.tsx` | 新增 | 语言管理 |
| `src/i18n/zh.json` | 新增 | 中文翻译 |
| `src/i18n/en.json` | 新增 | 英文翻译 |
| `src/components/Sidebar.tsx` | 重写 | 集成 Settings 功能 |
| `src/components/BottomNav.tsx` | 修改 | 深色模式 |
| `src/pages/Dashboard.tsx` | 修改 | i18n + 深色模式 |
| `src/App.tsx` | 修改 | 包裹 Provider |
| `src/index.css` | 修改 | 深色模式样式 |
| `tailwind.config.js` | 修改 | darkMode: 'class' |
| `src/components/SettingsView.tsx` | 删除 | 功能合并到 Sidebar |
